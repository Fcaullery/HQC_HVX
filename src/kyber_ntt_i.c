//
// Created by fcaullery on 21/07/25.
//

#include "kyber_ntt_i.h"
#include "hexagon_types.h"
#include "hvx.cfg.h"

const int16_t zetas_vec[128] = {
  -1044,  -758,  -359, -1517,  1493,  1422,   287,   202,
   -171,   622,  1577,   182,   962, -1202, -1474,  1468,
    573, -1325,   264,   383,  -829,  1458, -1602,  -130,
   -681,  1017,   732,   608, -1542,   411,  -205, -1571,
   1223,   652,  -552,  1015, -1293,  1491,  -282, -1544,
    516,    -8,  -320,  -666, -1618, -1162,   126,  1469,
   -853,   -90,  -271,   830,   107, -1421,  -247,  -951,
   -398,   961, -1508,  -725,   448, -1065,   677, -1275,
  -1103,   430,   555,   843, -1251,   871,  1550,   105,
    422,   587,   177,  -235,  -291,  -460,  1574,  1653,
   -246,   778,  1159,  -147,  -777,  1483,  -602,  1119,
  -1590,   644,  -872,   349,   418,   329,  -156,   -75,
    817,  1097,   603,   610,  1322, -1285, -1465,   384,
  -1215,  -136,  1218, -1335,  -874,   220, -1187, -1659,
  -1185, -1530, -1278,   794, -1510,  -854,  -870,   478,
   -108,  -308,   996,   991,   958, -1460,  1522,  1628
};

const int16_t zetas_4[64] __attribute__((aligned(128))) = 
                            {1493, 1493, 1493, 1493, 1493, 1493, 1493, 1493, 1493, 1493, 1493, 1493, 1493, 1493, 1493, 1493, 
                            1493, 1493, 1493, 1493, 1493, 1493, 1493, 1493, 1493, 1493, 1493, 1493, 1493, 1493, 1493, 1493, 
                            -1493, -1493, -1493, -1493, -1493, -1493, -1493, -1493, -1493, -1493, -1493, -1493, -1493, -1493, -1493, -1493,
                            -1493, -1493, -1493, -1493, -1493, -1493, -1493, -1493, -1493, -1493, -1493, -1493, -1493, -1493, -1493, -1493};
const int16_t zetas_5[64] __attribute__((aligned(128)))= 
                            {1422, 1422, 1422, 1422, 1422, 1422, 1422, 1422, 1422, 1422, 1422, 1422, 1422, 1422, 1422, 1422, 
                            1422, 1422, 1422, 1422, 1422, 1422, 1422, 1422, 1422, 1422, 1422, 1422, 1422, 1422, 1422, 1422, 
                            -1422, -1422, -1422, -1422, -1422, -1422, -1422, -1422, -1422, -1422, -1422, -1422, -1422, -1422, -1422, -1422,
                            -1422, -1422, -1422, -1422, -1422, -1422, -1422, -1422, -1422, -1422, -1422, -1422, -1422, -1422, -1422, -1422};
const int16_t zetas_6[64] __attribute__((aligned(128)))=
                            {287, 287, 287, 287, 287, 287, 287, 287, 287, 287, 287, 287, 287, 287, 287, 287, 
                            287, 287, 287, 287, 287, 287, 287, 287, 287, 287, 287, 287, 287, 287, 287, 287, 
                            -287, -287, -287, -287, -287, -287, -287, -287, -287, -287, -287, -287, -287, -287, -287, -287,
                            -287, -287, -287, -287, -287, -287, -287, -287, -287, -287, -287, -287, -287, -287, -287, -287};
const int16_t zetas_7[64] __attribute__((aligned(128)))= 
                            {202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 
                            202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 
                            -202, -202, -202, -202, -202, -202, -202, -202, -202, -202, -202, -202, -202, -202, -202, -202,
                            -202, -202, -202, -202, -202, -202, -202, -202, -202, -202, -202, -202, -202, -202, -202, -202};


//lvl 4
const uint8_t control_perm_lvl4[128] __attribute__((aligned(128)))=
                            {0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
                            0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
                            0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00,
                            0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00,
                            0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
                            0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
                            0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00,
                            0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00,
                            };

const int16_t zetas_8_9[64] __attribute__((aligned(128)))=
                            {-171, -171, -171, -171, -171, -171, -171, -171, -171, -171, -171, -171, -171, -171, -171, -171,
                            171, 171, 171, 171, 171, 171, 171, 171, 171, 171, 171, 171, 171, 171, 171, 171,
                            622, 622, 622, 622, 622, 622, 622, 622, 622, 622, 622, 622, 622, 622, 622, 622,
                            -622, -622, -622, -622, -622, -622, -622, -622, -622, -622, -622, -622, -622, -622, -622, -622};

const int16_t zetas_10_11[64] __attribute__((aligned(128)))=
                            {1577, 1577, 1577, 1577, 1577, 1577, 1577, 1577, 1577, 1577, 1577, 1577, 1577, 1577, 1577, 1577,
                            -1577, -1577, -1577, -1577, -1577, -1577, -1577, -1577, -1577, -1577, -1577, -1577, -1577, -1577, -1577, -1577,
                            182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182,
                            -182, -182, -182, -182, -182, -182, -182, -182, -182, -182, -182, -182, -182, -182, -182, -182};

const int16_t zetas_12_13[64] __attribute__((aligned(128)))=
                            {962, 962, 962, 962, 962, 962, 962, 962, 962, 962, 962, 962, 962, 962, 962, 962,
                            -962, -962, -962, -962, -962, -962, -962, -962, -962, -962, -962, -962, -962, -962, -962, -962,
                            -1202, -1202, -1202, -1202, -1202, -1202, -1202, -1202, -1202, -1202, -1202, -1202, -1202, -1202, -1202, -1202,
                            1202, 1202, 1202, 1202, 1202, 1202, 1202, 1202, 1202, 1202, 1202, 1202, 1202, 1202, 1202, 1202};

const int16_t zetas_14_15[64] __attribute__((aligned(128)))=
                            {-1474, -1474, -1474, -1474, -1474, -1474, -1474, -1474, -1474, -1474, -1474, -1474, -1474, -1474, -1474, -1474,
                            1474, 1474, 1474, 1474, 1474, 1474, 1474, 1474, 1474, 1474, 1474, 1474, 1474, 1474, 1474, 1474,
                            1468, 1468, 1468, 1468, 1468, 1468, 1468, 1468, 1468, 1468, 1468, 1468, 1468, 1468, 1468, 1468,
                            -1468, -1468, -1468, -1468, -1468, -1468, -1468, -1468, -1468, -1468, -1468, -1468, -1468, -1468, -1468, -1468};




//lvl 5
const uint8_t control_perm_lvl5[128] __attribute__((aligned(128)))=
                            {0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
                            0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00,
                            0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
                            0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00,
                            0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
                            0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00,
                            0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
                            0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00,
                            };

const int16_t zetas_16_19[64] __attribute__((aligned(128)))=
{573, 573, 573, 573, 573, 573, 573, 573, -573, -573, -573, -573, -573, -573, -573, -573,
-1325, -1325, -1325, -1325, -1325, -1325, -1325, -1325, 1325, 1325, 1325, 1325, 1325, 1325, 1325, 1325,
264, 264, 264, 264, 264, 264, 264, 264, -264, -264, -264, -264, -264, -264, -264, -264,
383, 383, 383, 383, 383, 383, 383, 383, -383, -383, -383, -383, -383, -383, -383, -383
};

const int16_t zetas_20_23[64] __attribute__((aligned(128)))=
{-829, -829, -829, -829, -829, -829, -829, -829, 829, 829, 829, 829, 829, 829, 829, 829,
1458, 1458, 1458, 1458, 1458, 1458, 1458, 1458, -1458, -1458, -1458, -1458, -1458, -1458, -1458, -1458,
-1602, -1602, -1602, -1602, -1602, -1602, -1602, -1602, 1602, 1602, 1602, 1602, 1602, 1602, 1602, 1602,
-130, -130, -130, -130, -130, -130, -130, -130, 130, 130, 130, 130, 130, 130, 130, 130};

const int16_t zetas_24_27[64] __attribute__((aligned(128)))=
{-681, -681, -681, -681, -681, -681, -681, -681, 681, 681, 681, 681, 681, 681, 681, 681,
1017, 1017, 1017, 1017, 1017, 1017, 1017, 1017, -1017, -1017, -1017, -1017, -1017, -1017, -1017, -1017,
732, 732, 732, 732, 732, 732, 732, 732, -732, -732, -732, -732, -732, -732, -732, -732,
608, 608, 608, 608, 608, 608, 608, 608, -608, -608, -608, -608, -608, -608, -608, -608};

const int16_t zetas_28_31[64] __attribute__((aligned(128)))=
{-1542, -1542, -1542, -1542, -1542, -1542, -1542, -1542, 1542, 1542, 1542, 1542, 1542, 1542, 1542, 1542,
411, 411, 411, 411, 411, 411, 411, 411, -411, -411, -411, -411, -411, -411, -411, -411,
-205, -205, -205, -205, -205, -205, -205, -205, 205, 205, 205, 205, 205, 205, 205, 205,
-1571, -1571, -1571, -1571, -1571, -1571, -1571, -1571, 1571, 1571, 1571, 1571, 1571, 1571, 1571, 1571};

//lvl 6
const uint8_t control_perm_lvl6[128] __attribute__((aligned(128)))=
                            {0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
                            0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00,
                            0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
                            0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00,
                            0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
                            0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00,
                            0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
                            0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00,
                            0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
                            0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00,
                            0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
                            0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00,
                            0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
                            0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00,
                            0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
                            0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00, 0b00,
                            };

const int16_t zetas_32_39[64] __attribute__((aligned(128)))=
{1223, 1223, 1223, 1223, -1223, -1223, -1223, -1223,
652, 652, 652, 652, -652, -652, -652, -652,
-552, -552, -552, -552, 552, 552, 552, 552,
1015, 1015, 1015, 1015, -1015, -1015, -1015, -1015,
-1293, -1293, -1293, -1293, 1293, 1293, 1293, 1293,
1491, 1491, 1491, 1491, -1491, -1491, -1491, -1491,
-282, -282, -282, -282, 282, 282, 282, 282,
-1544, -1544, -1544, -1544, 1544, 1544, 1544, 1544
};

const int16_t zetas_40_47[64] __attribute__((aligned(128)))=
{516, 516, 516, 516, -516, -516, -516, -516,
-8, -8, -8, -8, 8, 8, 8, 8,
-320, -320, -320, -320, 320, 320, 320, 320,
-666, -666, -666, -666, 666, 666, 666, 666,
-1618, -1618, -1618, -1618, 1618, 1618, 1618, 1618,
-1162, -1162, -1162, -1162, 1162, 1162, 1162, 1162,
126, 126, 126, 126, -126, -126, -126, -126,
1469, 1469, 1469, 1469, -1469, -1469, -1469, -1469};

const int16_t zetas_48_55[64] __attribute__((aligned(128)))=
{-853, -853, -853, -853, 853, 853, 853, 853,
-90, -90, -90, -90, 90, 90, 90, 90,
-271, -271, -271, -271, 271, 271, 271, 271,
830, 830, 830, 830, -830, -830, -830, -830,
107, 107, 107, 107, -107, -107, -107, -107,
-1421, -1421, -1421, -1421, 1421, 1421, 1421, 1421,
-247, -247, -247, -247, 247, 247, 247, 247,
-951, -951, -951, -951, 951, 951, 951, 951};

const int16_t zetas_56_63[64] __attribute__((aligned(128)))=
{-398, -398, -398, -398, 398, 398, 398, 398,
961, 961, 961, 961, -961, -961, -961, -961,
-1508, -1508, -1508, -1508, 1508, 1508, 1508, 1508,
-725, -725, -725, -725, 725, 725, 725, 725,
448, 448, 448, 448, -448, -448, -448, -448,
-1065, -1065, -1065, -1065, 1065, 1065, 1065, 1065,
677, 677, 677, 677, -677, -677, -677, -677,
-1275, -1275, -1275, -1275, 1275, 1275, 1275, 1275};

//lvl 7
const uint8_t control_perm_lvl7[128] __attribute__((aligned(128)))=
                            {0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00,
                            0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00,
                            0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00,
                            0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00,
                            0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00,
                            0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00,
                            0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00,
                            0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00,
                            0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00,
                            0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00,
                            0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00,
                            0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00,
                            0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00,
                            0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00,
                            0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00,
                            0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00,
                            };

const int16_t zetas_64_79[64] __attribute__((aligned(128)))=
{-1103, -1103, 1103, 1103,
430, 430, -430, -430,
555, 555, -555, -555,
843, 843, -843, -843,
-1251, -1251, 1251, 1251,
871, 871, -871, -871,
1550, 1550, -1550, -1550,
105, 105, -105, -105,
422, 422, -422, -422,
587, 587, -587, -587,
177, 177, -177, -177,
-235, -235, 235, 235,
-291, -291, 291, 291,
-460, -460, 460, 460,
1574, 1574, -1574, -1574,
1653, 1653, -1653, -1653
};

const int16_t zetas_80_95[64] __attribute__((aligned(128)))=
{-246, -246, 246, 246,
778, 778, -778, -778,
1159, 1159, -1159, -1159,
-147, -147, 147, 147,
-777, -777, 777, 777,
1483, 1483, -1483, -1483,
-602, -602, 602, 602,
1119, 1119, -1119, -1119,
-1590, -1590, 1590, 1590,
644, 644, -644, -644,
-872, -872, 872, 872,
349, 349, -349, -349,
418, 418, -418, -418,
329, 329, -329, -329,
-156, -156, 156, 156,
-75, -75, 75, 75};

const int16_t zetas_96_111[64] __attribute__((aligned(128)))=
{
    817, 817, -817, -817,
    1097, 1097, -1097, -1097,
    603, 603, -603, -603,
    610, 610, -610, -610,
    1322, 1322, -1322, -1322,
    -1285, -1285, 1285, 1285,
    -1465, -1465, 1465, 1465,
    384, 384, -384, -384,
    -1215, -1215, 1215, 1215,
    -136, -136, 136, 136,
    1218, 1218, -1218, -1218,
    -1335, -1335, 1335, 1335,
    -874, -874, 874, 874,
    220, 220, -220, -220,
    -1187, -1187, 1187, 1187,
    -1659, -1659, 1659, 1659};

const int16_t zetas_112_127[64] __attribute__((aligned(128)))=
{-1185, -1185, 1185, 1185,
-1530, -1530, 1530, 1530,
-1278, -1278, 1278, 1278,
794, 794, -794, -794,
-1510, -1510, 1510, 1510,
-854, -854, 854, 854,
-870, -870, 870, 870,
478, 478, -478, -478,
-108, -108, 108, 108,
-308, -308, 308, 308,
996, 996, -996, -996,
991, 991, -991, -991,
958, 958, -958, -958,
-1460, -1460, 1460, 1460,
1522, 1522, -1522, -1522,
1628, 1628, -1628, -1628};





static HVX_Vector fqmul_vec(HVX_Vector a, HVX_Vector b){

  HVX_VectorPair pair = Q6_Ww_vmpy_VhVh(a, b);
  HVX_Vector t_even = Q6_Vw_vmpyi_VwRh(Q6_V_hi_W(pair), 0xF301F301); // int16 QINV=-3327 duplicated into 32b
  HVX_Vector t_odd = Q6_Vw_vmpyi_VwRh(Q6_V_lo_W(pair), 0xF301F301); // int16 QINV=-3327 duplicated into 32b
  HVX_Vector tmp = Q6_Vh_vshuffe_VhVh(t_even, t_odd);

  HVX_VectorPair pair_1 = Q6_Ww_vmpy_VhRh(tmp, 0x0d010d01); //Kyber_Q duplicated
  pair = Q6_Ww_vsub_WwWw(pair, pair_1);

  t_even = Q6_Vw_vasr_VwR(Q6_V_hi_W(pair), 16);
  t_odd = Q6_Vw_vasr_VwR(Q6_V_lo_W(pair), 16);

  return Q6_Vh_vshuffe_VhVh(t_even, t_odd);
}

void ntt(int16_t r[256]){

  HVX_Vector *r_vec = (HVX_Vector *)r;
  HVX_Vector r0 = r_vec[0];
  HVX_Vector r1 = r_vec[1];
  HVX_Vector r2 = r_vec[2];
  HVX_Vector r3 = r_vec[3];

  //lvl 1
  HVX_Vector zetas = Q6_Vh_vsplat_R(zetas_vec[1]);
  zetas = fqmul_vec(r2, zetas);
  r0 += zetas;
  r2 -= zetas;
  zetas = fqmul_vec(r3, zetas);
  r1 += zetas;
  r3 -= zetas;

  //lvl2
  zetas = Q6_Vh_vsplat_R(zetas_vec[2]);
  zetas = fqmul_vec(r1, zetas);
  r0 += zetas;
  r1 -= zetas;
  zetas = Q6_Vh_vsplat_R(zetas_vec[3]);
  zetas = fqmul_vec(r3, zetas);
  r2 += zetas;
  r3 -= zetas;

  //lvl3
  HVX_Vector tmp = Q6_V_vlalign_VVR( Q6_V_vror_VR(r0, 64), r0, 64);
  HVX_Vector *zeta_p = (HVX_Vector *)zetas_4;
  tmp = fqmul_vec(tmp, *zeta_p);
  r0 += tmp;
  tmp = Q6_V_vlalign_VVR( Q6_V_vror_VR(r1, 64), r1, 64);
  zeta_p = (HVX_Vector *)zetas_5;
  tmp = fqmul_vec(tmp, *zeta_p);
  r1 += tmp;
  tmp = Q6_V_vlalign_VVR( Q6_V_vror_VR(r2, 64), r2, 64);
  zeta_p = (HVX_Vector *)zetas_6;
  tmp = fqmul_vec(tmp, *zeta_p);
  r2 += tmp;
  tmp = Q6_V_vlalign_VVR( Q6_V_vror_VR(r3, 64), r3, 64);
  zeta_p = (HVX_Vector *)zetas_7;
  tmp = fqmul_vec(tmp, *zeta_p);
  r3 += tmp;

  //lvl4

  HVX_Vector perm_mask = *((HVX_Vector *)control_perm_lvl4);
  tmp = Q6_V_vdelta_VV(r0, perm_mask);
  zeta_p = (HVX_Vector *)zetas_8_9;
  tmp = fqmul_vec(tmp, *zeta_p);
  r0 += tmp;
  tmp = Q6_V_vdelta_VV(r1, perm_mask);
  zeta_p = (HVX_Vector *)zetas_10_11;
  tmp = fqmul_vec(tmp, *zeta_p);
  r1 += tmp;
  tmp = Q6_V_vdelta_VV(r2, perm_mask);
  zeta_p = (HVX_Vector *)zetas_12_13;
  tmp = fqmul_vec(tmp, *zeta_p);
  r2 += tmp;
  tmp = Q6_V_vdelta_VV(r3, perm_mask);
  zeta_p = (HVX_Vector *)zetas_14_15;
  tmp = fqmul_vec(tmp, *zeta_p);
  r3 += tmp;

  //lvl5

  perm_mask = *((HVX_Vector *)control_perm_lvl5);
  tmp = Q6_V_vdelta_VV(r0, perm_mask);
  zeta_p = (HVX_Vector *)zetas_16_19;
  tmp = fqmul_vec(tmp, *zeta_p);
  r0 += tmp;
  tmp = Q6_V_vdelta_VV(r1, perm_mask);
  zeta_p = (HVX_Vector *)zetas_20_23;
  tmp = fqmul_vec(tmp, *zeta_p);
  r1 += tmp;
  tmp = Q6_V_vdelta_VV(r2, perm_mask);
  zeta_p = (HVX_Vector *)zetas_24_27;
  tmp = fqmul_vec(tmp, *zeta_p);
  r2 += tmp;
  tmp = Q6_V_vdelta_VV(r3, perm_mask);
  zeta_p = (HVX_Vector *)zetas_28_31;
  tmp = fqmul_vec(tmp, *zeta_p);
  r3 += tmp;

  //lvl6

  perm_mask = *((HVX_Vector *)control_perm_lvl6);
  tmp = Q6_V_vdelta_VV(r0, perm_mask);
  zeta_p = (HVX_Vector *)zetas_32_39;
  tmp = fqmul_vec(tmp, *zeta_p);
  r0 += tmp;
  tmp = Q6_V_vdelta_VV(r1, perm_mask);
  zeta_p = (HVX_Vector *)zetas_40_47;
  tmp = fqmul_vec(tmp, *zeta_p);
  r1 += tmp;
  tmp = Q6_V_vdelta_VV(r2, perm_mask);
  zeta_p = (HVX_Vector *)zetas_48_55;
  tmp = fqmul_vec(tmp, *zeta_p);
  r2 += tmp;
  tmp = Q6_V_vdelta_VV(r3, perm_mask);
  zeta_p = (HVX_Vector *)zetas_56_63;
  tmp = fqmul_vec(tmp, *zeta_p);
  r3 += tmp;

  //lvl7

  perm_mask = *((HVX_Vector *)control_perm_lvl7);
  tmp = Q6_V_vdelta_VV(r0, perm_mask);
  zeta_p = (HVX_Vector *)zetas_64_79;
  tmp = fqmul_vec(tmp, *zeta_p);
  r0 += tmp;
  tmp = Q6_V_vdelta_VV(r1, perm_mask);
  zeta_p = (HVX_Vector *)zetas_80_95;
  tmp = fqmul_vec(tmp, *zeta_p);
  r1 += tmp;
  tmp = Q6_V_vdelta_VV(r2, perm_mask);
  zeta_p = (HVX_Vector *)zetas_96_111;
  tmp = fqmul_vec(tmp, *zeta_p);
  r2 += tmp;
  tmp = Q6_V_vdelta_VV(r3, perm_mask);
  zeta_p = (HVX_Vector *)zetas_112_127;
  tmp = fqmul_vec(tmp, *zeta_p);
  r3 += tmp;

  r_vec[0] = r0;
  r_vec[1] = r1;
  r_vec[2] = r2;
  r_vec[3] = r3;

  return;
}